<Page x:Class="RetailMobile.Presentation.ProductListPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:RetailMobile.Presentation"
      xmlns:uen="using:Uno.Extensions.Navigation.UI"
      xmlns:utu="using:Uno.Toolkit.UI"
      xmlns:um="using:Uno.Material"
      xmlns:helpers="using:RetailMobile.Helpers"
      NavigationCacheMode="Required"
      Background="#F9F9F9">
    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:InvertedBoolToVisibilityConverter x:Key="InvertedBoolToVisibilityConverter" />
        <helpers:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <helpers:DecimalToCurrencyConverter x:Key="DecimalToCurrencyConverter" />
        <helpers:StockTextConverter x:Key="StockTextConverter" />
    </Page.Resources>
    
    <Grid utu:SafeArea.Insets="VisibleBounds">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
        </Grid.RowDefinitions>

        <!-- Custom Header Bar -->
        <Grid Grid.Row="0" 
              Height="56" 
              Background="White"
              Padding="16,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Menu Button -->
            <Button Grid.Column="0" 
                    Width="32" 
                    Height="32"
                    Background="#F2F2F2"
                    CornerRadius="100"
                    Padding="0"
                    VerticalAlignment="Center">
                <FontIcon Glyph="&#xE700;" 
                          FontSize="16"
                          Foreground="#323232" />
            </Button>

            <!-- Logo -->
            <Image Grid.Column="1"
                   Width="50"
                   Height="40"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Source="ms-appx:///Assets/logo.png" />

            <!-- Profile Picture -->
            <Ellipse Grid.Column="2"
                     Width="40"
                     Height="40"
                     VerticalAlignment="Center">
                <Ellipse.Fill>
                    <ImageBrush ImageSource="ms-appx:///Assets/profile.png" />
                </Ellipse.Fill>
            </Ellipse>
        </Grid>

        <!-- Search Bar -->
        <Grid Grid.Row="1" 
              Margin="16,12,16,8">
            <Border Background="White"
                    CornerRadius="6"
                    Padding="16,0"
                    Height="40">
                <Border.Shadow>
                    <ThemeShadow />
                </Border.Shadow>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>

                    <!-- Search Icon -->
                    <FontIcon Grid.Column="0"
                              Glyph="&#xE721;"
                              FontSize="20"
                              Foreground="#BBBBBB"
                              VerticalAlignment="Center"
                              Margin="0,0,10,0" />

                    <!-- Search TextBox -->
                    <TextBox Grid.Column="1"
                             Text="{Binding SearchText, Mode=TwoWay}"
                             PlaceholderText="Search any Product.."
                             BorderThickness="0"
                             Background="Transparent"
                             KeyDown="OnSearchKeyDown"
                             VerticalAlignment="Center"
                             FontFamily="Montserrat"
                             FontSize="14"
                             PlaceholderForeground="#BBBBBB"
                             Foreground="Black" />
                </Grid>
            </Border>
        </Grid>

        <!-- Items Count and Filter/Sort Bar -->
        <Grid Grid.Row="2" 
              Margin="16,8,16,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="8" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Items Count -->
            <TextBlock Grid.Column="0"
                       VerticalAlignment="Center"
                       FontFamily="Montserrat"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Foreground="Black">
                <Run Text="{Binding Products.Count}"/>
                <Run Text="+ Items" />
            </TextBlock>

            <!-- Sort Button -->
            <Button Grid.Column="1"
                    Background="White"
                    BorderBrush="#E8E8E8"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12,8"
                    Height="36">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <FontIcon Glyph="&#xE8CB;" 
                              FontSize="14"
                              Foreground="Black" />
                    <TextBlock Text="Sort"
                               FontFamily="Montserrat"
                               FontSize="12"
                               Foreground="Black"
                               VerticalAlignment="Center" />
                </StackPanel>
                <Button.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Tên sản phẩm" Click="OnSortOptionClick" Tag="Tên sản phẩm" />
                        <MenuFlyoutItem Text="Giá tăng dần" Click="OnSortOptionClick" Tag="Giá tăng dần" />
                        <MenuFlyoutItem Text="Giá giảm dần" Click="OnSortOptionClick" Tag="Giá giảm dần" />
                    </MenuFlyout>
                </Button.Flyout>
            </Button>

            <!-- Filter Button -->
            <Button Grid.Column="3"
                    Background="White"
                    BorderBrush="#E8E8E8"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12,8"
                    Height="36">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <FontIcon Glyph="&#xE71C;" 
                              FontSize="14"
                              Foreground="Black" />
                    <TextBlock Text="Filter"
                               FontFamily="Montserrat"
                               FontSize="12"
                               Foreground="Black"
                               VerticalAlignment="Center" />
                </StackPanel>
                <Button.Flyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Tất cả" Click="OnCategoryFilterClick" Tag="Tất cả" />
                        <MenuFlyoutItem Text="Đồ uống" Click="OnCategoryFilterClick" Tag="Đồ uống" />
                        <MenuFlyoutItem Text="Bánh kẹo" Click="OnCategoryFilterClick" Tag="Bánh kẹo" />
                        <MenuFlyoutItem Text="Gia vị" Click="OnCategoryFilterClick" Tag="Gia vị" />
                        <MenuFlyoutItem Text="Đồ gia dụng" Click="OnCategoryFilterClick" Tag="Đồ gia dụng" />
                        <MenuFlyoutItem Text="Mỹ phẩm" Click="OnCategoryFilterClick" Tag="Mỹ phẩm" />
                    </MenuFlyout>
                </Button.Flyout>
            </Button>
        </Grid>

        <!-- Product Grid Container -->
        <ScrollViewer Grid.Row="3" 
                     VerticalScrollBarVisibility="Auto">
            <ItemsRepeater ItemsSource="{Binding Products}"
                          Margin="8">
                <ItemsRepeater.Layout>
                    <UniformGridLayout MinItemWidth="180"
                                      MinColumnSpacing="8"
                                      MinRowSpacing="8" />
                </ItemsRepeater.Layout>
                
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White"
                                CornerRadius="8"
                                BorderBrush="#E8E8E8"
                                BorderThickness="1"
                                Tapped="OnProductItemClick">
                            
                            <Grid Width="164" Height="245">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="136" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <!-- Product Image -->
                                <Border Grid.Row="0"
                                        CornerRadius="8,8,0,0"
                                        Background="#F5F5F5">
                                    <Image Source="{Binding ImageUrl}"
                                           Stretch="UniformToFill" />
                                </Border>

                                <!-- Product Info -->
                                <StackPanel Grid.Row="1"
                                           Padding="8"
                                           Spacing="4">
                                    
                                    <!-- Product Name -->
                                    <TextBlock Text="{Binding ProductName}"
                                               FontFamily="Montserrat"
                                               FontSize="14"
                                               FontWeight="Medium"
                                               Foreground="Black"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="1" />
                                    
                                    <!-- Category -->
                                    <TextBlock Text="{Binding CategoryName}"
                                               FontFamily="Montserrat"
                                               FontSize="10"
                                               Foreground="Gray"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="1" />
                                    <!-- Stock -->
                                    <TextBlock FontFamily="Montserrat"
                                            FontSize="10"
                                            Foreground="#666666"
                                            Margin="0,2,0,0">
                                        <Run Text="Còn lại: " />
                                        <Run Text="{Binding CurrentStock}" FontWeight="SemiBold" />
                                        <Run Text=" sp" />
                                    </TextBlock>
                                    <!-- Price -->
                                    <TextBlock FontFamily="Montserrat"
                                               FontSize="14"
                                               FontWeight="SemiBold"
                                               Foreground="#EDB310"
                                               Margin="0,4,0,0">
                                        <Run Text="{Binding Price, Converter={StaticResource DecimalToCurrencyConverter}}" />
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </ScrollViewer>
    </Grid>
</Page>
