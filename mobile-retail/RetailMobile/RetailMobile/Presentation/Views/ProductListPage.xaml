<Page x:Class="RetailMobile.Presentation.ProductListPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:RetailMobile.Presentation"
      xmlns:uen="using:Uno.Extensions.Navigation.UI"
      xmlns:utu="using:Uno.Toolkit.UI"
      xmlns:um="using:Uno.Material"
      xmlns:helpers="using:RetailMobile.Helpers"
      NavigationCacheMode="Required"
      Background="{ThemeResource BackgroundBrush}"
      Loaded="OnPageLoaded">
    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:InvertedBoolToVisibilityConverter x:Key="InvertedBoolToVisibilityConverter" />
        <helpers:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <helpers:DecimalToCurrencyConverter x:Key="DecimalToCurrencyConverter" />
        <helpers:StockTextConverter x:Key="StockTextConverter" />
    </Page.Resources>
    
    <Grid utu:SafeArea.Insets="VisibleBounds">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
        </Grid.RowDefinitions>

        <!-- Navigation Bar -->
        <utu:NavigationBar Content="{Binding Title}" 
                          Grid.Row="0"
                          Style="{StaticResource MaterialNavigationBarStyle}" />

        <!-- Filter and Sort Bar -->
        <Grid Grid.Row="1"
              Margin="16,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
                <ColumnDefinition Width="8" />
                <ColumnDefinition />
            </Grid.ColumnDefinitions>

            <ComboBox Grid.Column="0"
                     Header="Phân loại"
                     ItemsSource="{Binding Categories}"
                     SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                     HorizontalAlignment="Stretch"
                     SelectionChanged="OnFilterOrSortChanged" />

            <ComboBox Grid.Column="2"
                     Header="Sắp xếp"
                     ItemsSource="{Binding SortOptions}"
                     SelectedItem="{Binding SelectedSortOption, Mode=TwoWay}"
                     HorizontalAlignment="Stretch"
                     SelectionChanged="OnFilterOrSortChanged" />
        </Grid>

        <!-- Search Bar with Modern Design -->
        <Grid Grid.Row="2" 
              Margin="16,12,16,8">
            <Border Background="{ThemeResource SurfaceBrush}"
                    CornerRadius="12"
                    Padding="4"
                    BorderThickness="1"
                    BorderBrush="{ThemeResource DividerBrush}">
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Search TextBox -->
                    <TextBox Grid.Column="0"
                             Text="{Binding SearchText, Mode=TwoWay}"
                             PlaceholderText="Tìm kiếm sản phẩm..."
                             BorderThickness="0"
                             Background="Transparent"
                             KeyDown="OnSearchKeyDown"
                             VerticalAlignment="Center" />

                    <!-- Search Button -->
                    <Button Grid.Column="1"
                            Content="Tìm"
                            Command="{Binding SearchCommand}"
                            Style="{StaticResource FilledButtonStyle}"
                            CornerRadius="8"
                            Margin="4"
                            Padding="16,8" />
                </Grid>
            </Border>
        </Grid>

        <!-- Product List Container -->
        <Grid Grid.Row="3">
            <!-- Loading Indicator -->
            <ProgressRing IsActive="{Binding IsLoading}"
                          Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                          Width="48"
                          Height="48"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Foreground="{ThemeResource PrimaryBrush}" />

            <!-- Error Message with Icon -->
            <StackPanel Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Spacing="12">
                <TextBlock Text="⚠️"
                          FontSize="48"
                          HorizontalAlignment="Center" />
                <TextBlock Text="{Binding ErrorMessage}"
                          Foreground="{ThemeResource OnSurfaceBrush}"
                          TextWrapping="Wrap"
                          TextAlignment="Center"
                          MaxWidth="300"
                          FontSize="14" />
            </StackPanel>

            <!-- Products ListView with Enhanced Cards -->
            <ListView ItemsSource="{Binding Products}"
                     Visibility="{Binding IsLoading, Converter={StaticResource InvertedBoolToVisibilityConverter}}"
                     SelectionMode="None"
                     IsItemClickEnabled="True"
                     ItemClick="OnProductItemClick"
                     Padding="12,8"
                     Background="Transparent">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0,0,0,12" />
                    </Style>
                </ListView.ItemContainerStyle>
                
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <!-- Enhanced Product Card -->
                        <Border Background="{ThemeResource SurfaceBrush}"
                                CornerRadius="16"
                                Padding="12"
                                BorderThickness="1"
                                BorderBrush="{ThemeResource DividerBrush}">
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition />
                                </Grid.ColumnDefinitions>

                                <!-- Product Image -->
                                <Grid Grid.Column="0">
                                    <Border Width="100"
                                            Height="100"
                                            CornerRadius="12"
                                            Background="{ThemeResource SurfaceVariantBrush}">
                                        <Image Source="{Binding ImageUrl}"
                                               Stretch="UniformToFill" />
                                    </Border>
                                </Grid>

                                <!-- Product Info with Better Hierarchy -->
                                <StackPanel Grid.Column="1"
                                           Margin="16,4,8,4"
                                           Spacing="4"
                                           VerticalAlignment="Center">
                                    
                                    <!-- Category Badge -->
                                    <Border Background="{ThemeResource SecondaryContainerBrush}"
                                            CornerRadius="4"
                                            Padding="8,2"
                                            HorizontalAlignment="Left">
                                        <TextBlock Text="{Binding CategoryName}"
                                                   FontSize="10"
                                                   FontWeight="Medium"
                                                   Foreground="{ThemeResource OnSecondaryContainerBrush}" />
                                    </Border>
                                    
                                    <!-- Product Name -->
                                    <TextBlock Text="{Binding ProductName}"
                                               FontSize="16"
                                               FontWeight="SemiBold"
                                               Foreground="{ThemeResource OnSurfaceBrush}"
                                               TextTrimming="CharacterEllipsis"
                                               MaxLines="2"
                                               LineHeight="22" />
                                    
                                    <!-- Price with Accent -->
                                    <StackPanel Orientation="Horizontal" 
                                               Spacing="4"
                                               Margin="0,4,0,0">
                                        <TextBlock FontSize="20"
                                                   FontWeight="Bold"
                                                   Foreground="{ThemeResource PrimaryBrush}">
                                            <Run Text="{Binding Price, Converter={StaticResource DecimalToCurrencyConverter}}" />
                                            <Run Text="₫" />
                                        </TextBlock>
                                    </StackPanel>
                                    
                                    <!-- Stock Text -->
                                    <TextBlock Text="{Binding CurrentStock, Converter={StaticResource StockTextConverter}}"
                                               FontSize="12"
                                               Foreground="{ThemeResource OnSurfaceVariantBrush}" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- Refresh Button with Text -->
        <Button Grid.Row="3"
                Content="Làm mới"
                Command="{Binding RefreshCommand}"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,20,20"
                Width="Auto"
                Height="48"
                CornerRadius="24"
                Padding="24,0"
                Style="{StaticResource FilledButtonStyle}"
                Background="{ThemeResource PrimaryBrush}" />
    </Grid>
</Page>
